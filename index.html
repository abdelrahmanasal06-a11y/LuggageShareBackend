<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WeightShare — Search & Add</title>
<style>
/* (same compact CSS as before - omitted here to save space, use your existing CSS or copy the CSS from the previous file) */
body { font-family: Arial, Helvetica, sans-serif; margin: 0; background: #f7fafc; color:#0b1220; }
.container{max-width:1100px;margin:0 auto;padding:18px;}
header{background:#fff;padding:12px 18px;box-shadow:0 6px 18px rgba(2,6,23,0.06);display:flex;justify-content:space-between;align-items:center}
.logo{color:#0ea5ff;font-weight:700}
.btn{background:#0f172a;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.search-bar{background:#fff;padding:12px;border-radius:10px;display:flex;gap:8px;align-items:center;margin-top:18px;box-shadow:0 4px 12px rgba(2,6,23,.06)}
.input{padding:10px;border-radius:8px;border:1px solid #e6eef8;min-width:140px}
.select{padding:10px;border-radius:8px;border:1px solid #e6eef8}
.search-btn{background:#0ea5ff;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
.results{margin-top:20px}
.date-header{font-weight:700;margin:18px 0 8px}
.ticket{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:12px;border-radius:8px;margin-bottom:8px;box-shadow:0 4px 10px rgba(2,6,23,.06)}
.ticket-left{display:flex;flex-direction:column;gap:6px}
.route{font-weight:700}
.meta{color:#6b7280;font-size:13px}
.price{font-weight:800}
.wha{background:#25D366;color:#fff;border:none;padding:6px 8px;border-radius:8px;cursor:pointer}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:120}
.modal{background:#fff;padding:16px;border-radius:10px;max-width:720px;width:95%}
.toast{position:fixed;top:18px;left:50%;transform:translateX(-50%);background:#16a34a;color:#fff;padding:10px 14px;border-radius:8px;z-index:200}
.small-muted{color:#6b7280}
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;padding:0">
    <div class="logo">WeightShare</div>
    <div><button id="openAdd" class="btn">➕ Add Request</button></div>
  </div>
</header>

<div class="container">
  <div class="search-bar">
    <select id="searchType" class="select">
      <option value="">Any type</option>
      <option value="shipper">Shipper</option>
      <option value="traveller">Traveller</option>
    </select>
    <input id="searchFrom" class="input" placeholder="From (city/airport)" />
    <input id="searchTo" class="input" placeholder="To (city/airport)" />
    <input id="searchDate" class="input" type="date" />
    <button id="doSearch" class="search-btn">Search</button>
  </div>

  <div id="resultsRoot" class="results"></div>
</div>

<div id="modalRoot" style="display:none"></div>
<div id="successRoot" style="display:none"></div>
<div id="toastRoot" style="position:fixed;top:0;left:0;right:0;pointer-events:none"></div>

<script>
const WORKER = 'https://weightshare-backend.weightshare.workers.dev';
const ADD_PATH = '/add-request';
const LIST_PATH = '/list';
const CLOSE_PATH = '/close-request';

function showToast(text, auto=2000){ const r=document.getElementById('toastRoot'); r.innerHTML=`<div class="toast">${text}</div>`; if(auto) setTimeout(()=>r.innerHTML='',auto); }

async function apiList(q={}) {
  const p = new URLSearchParams();
  if (q.from) p.set('from', q.from);
  if (q.to) p.set('to', q.to);
  if (q.date) p.set('date', q.date);
  if (q.type) p.set('type', q.type);
  const res = await fetch(WORKER + LIST_PATH + (p.toString() ? '?'+p.toString() : ''));
  return await res.json();
}
async function apiAdd(obj) {
  const res = await fetch(WORKER + ADD_PATH, {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(obj)
  });
  return await res.json();
}
async function apiClose(id) {
  const res = await fetch(WORKER + CLOSE_PATH, {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id })
  });
  return await res.json();
}

function cleanPhone(phone){ if(!phone) return ''; let p = String(phone).trim(); p = p.replace(/\D/g,''); return p; }

function renderTickets(list){
  const root = document.getElementById('resultsRoot'); root.innerHTML='';
  if(!Array.isArray(list)||list.length===0){ root.innerHTML='<div class="small-muted">No open requests</div>'; return; }
  // group by datepickup
  const groups = {};
  list.forEach(it=>{
    const dp = it.datepickup ? new Date(it.datepickup).toISOString().slice(0,10) : 'no-date';
    if(!groups[dp]) groups[dp]=[];
    groups[dp].push(it);
  });
  const keys = Object.keys(groups).sort();
  keys.forEach(k=>{
    const pretty = k==='no-date' ? 'No date' : new Date(k).toLocaleDateString(undefined,{ weekday:'long', day:'numeric', month:'short'});
    const header = document.createElement('div'); header.className='date-header'; header.textContent = pretty;
    root.appendChild(header);
    groups[k].forEach(item=>{
      const price = (item.price_per_kg !== undefined && item.price_per_kg !== null && item.price_per_kg !== '') ? item.price_per_kg + ' €/kg' : 'VB';
      const type = item.type || ( (item.additionalinfo||'').match(/^Type:\s*(shipper|traveller)/i) ? item.additionalinfo.match(/^Type:\s*(shipper|traveller)/i)[1].toLowerCase() : '' );
      const ticket = document.createElement('div'); ticket.className='ticket';
      ticket.innerHTML = `
        <div class="ticket-left">
          <div class="route">${ item.from_loc || item.from || '' } → ${ item.to_loc || item.to || '' } ${ type ? ' • ' + type : '' }</div>
          <div class="meta">${ item.name || '—' } • <span class="small-muted">${ item.mobile || '' }</span></div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <button class="wha" data-wa="${cleanPhone(item.mobile)}">WhatsApp</button>
          <div class="price">${price}</div>
        </div>
      `;
      // open detail on left click
      ticket.querySelector('.ticket-left').addEventListener('click', ()=>openDetail(item));
      // whatsapp
      ticket.querySelector('.wha').addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const wa = ev.currentTarget.dataset.wa || '';
        if(!wa){ showToast('No phone number'); return; }
        window.open('https://wa.me/' + wa, '_blank');
      });
      root.appendChild(ticket);
    });
  });
}

function openDetail(item){
  const root = document.getElementById('modalRoot'); root.style.display='block';
  const price = (item.price_per_kg !== undefined && item.price_per_kg !== null && item.price_per_kg !== '') ? item.price_per_kg + ' €/kg' : 'VB';
  const created = item.createdat ? new Date(item.createdat).toLocaleString() : '';
  const type = item.type || ( (item.additionalinfo||'').match(/^Type:\s*(shipper|traveller)/i) ? item.additionalinfo.match(/^Type:\s*(shipper|traveller)/i)[1] : '—' );
  root.innerHTML = `
    <div class="modal-backdrop">
      <div class="modal">
        <h3>${item.from_loc || item.from} → ${item.to_loc || item.to}</h3>
        <p><strong>${item.name||'—'}</strong> • Type: ${type}</p>
        <p class="small-muted">Date: ${item.datepickup || '—'}</p>
        <p class="small-muted">Phone: ${item.mobile || '—'}</p>
        <p class="small-muted">Email: ${item.email || '—'}</p>
        <p style="margin-top:8px">${ (item.additionalinfo||'').replace(/^Type:\s*(shipper|traveller)[:\-\s]*/i,'') || '' }</p>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button id="closeDetailBtn" class="btn">Close</button>
          <button id="closeRequestBtn" class="btn" style="background:#ef4444">Close Request</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('closeDetailBtn').addEventListener('click', ()=>{ root.style.display='none'; root.innerHTML='';});
  document.getElementById('closeRequestBtn').addEventListener('click', async ()=>{
    const confirmId = prompt('Enter Request ID to confirm:');
    if(!confirmId || confirmId !== item.id){ alert('Cancelled or ID mismatch'); return; }
    showToast('Closing...');
    const res = await apiClose(item.id);
    if(res && res.status === 'ok'){ showToast('Closed'); root.style.display='none'; root.innerHTML=''; doSearch(); }
    else showToast('Close failed: ' + (res?.message || 'error'));
  });
}

function openAddModal(){
  const root = document.getElementById('modalRoot'); root.style.display='block';
  root.innerHTML = `
    <div class="modal-backdrop">
      <div class="modal">
        <h3>Submit a Request</h3>
        <form id="addForm">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div><label>Your name</label><input name="name" required class="input" /></div>
            <div><label>Type</label><select name="type" class="select"><option value="shipper">Shipper</option><option value="traveller">Traveller</option></select></div>
            <div><label>From</label><input name="from" required class="input" /></div>
            <div><label>To</label><input name="to" required class="input" /></div>
            <div><label>Pickup date</label><input name="datepickup" type="date" class="input" /></div>
            <div><label>Price per kg (€)</label><input name="price_per_kg" type="number" step="0.01" class="input" /></div>
            <div><label>Mobile</label><input name="mobile" class="input" /></div>
            <div><label>Email</label><input name="email" type="email" class="input" /></div>
            <div style="grid-column:1/-1"><label>Additional info</label><textarea name="additionalinfo" class="input" style="min-height:80px"></textarea></div>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
            <button type="button" id="cancelAdd" class="btn">Cancel</button>
            <button type="submit" class="btn">Submit Request</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.getElementById('cancelAdd').addEventListener('click', ()=>{ document.getElementById('modalRoot').style.display='none'; document.getElementById('modalRoot').innerHTML='';});
  document.getElementById('addForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fm = new FormData(e.target);
    const obj = Object.fromEntries(fm.entries());
    if(!obj.price_per_kg) obj.price_per_kg = null;
    // submit type as own field (do NOT put Type:... in additionalinfo)
    showToast('Submitting...');
    const res = await apiAdd(obj);
    if(res && res.status === 'ok'){
      showSuccessModal(res.id);
      document.getElementById('modalRoot').style.display='none'; document.getElementById('modalRoot').innerHTML='';
      doSearch();
    } else {
      showToast('Submit failed: ' + (res?.message || 'error'), 3000);
    }
  });
}

function showSuccessModal(id){
  const root = document.getElementById('successRoot'); root.style.display='block';
  root.innerHTML = `<div class="modal-backdrop"><div class="modal"><h3 style="color:#16a34a">Request created</h3><p>Save this ID to close later:</p><div style="display:flex;gap:8px;align-items:center;justify-content:center"><div style="background:#f3f4f6;padding:8px 12px;border-radius:8px">${id}</div><button id="copyId" class="btn">Copy ID</button></div><div style="margin-top:12px;display:flex;justify-content:center"><button id="closeOk" class="btn">OK</button></div></div></div>`;
  document.getElementById('copyId').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(id); showToast('Copied'); }catch(e){ showToast('Copy failed'); }});
  document.getElementById('closeOk').addEventListener('click', ()=>{ root.style.display='none'; root.innerHTML=''; });
}

document.getElementById('openAdd').addEventListener('click', openAddModal);
document.getElementById('doSearch').addEventListener('click', (e)=>{ e.preventDefault(); doSearch(); });

async function doSearch(){
  const type = document.getElementById('searchType').value;
  const from = document.getElementById('searchFrom').value;
  const to = document.getElementById('searchTo').value;
  const date = document.getElementById('searchDate').value;
  showToast('Searching...', 800);
  const data = await apiList({ type, from, to, date });
  if(!Array.isArray(data)){
    showToast('Search failed', 2000);
    document.getElementById('resultsRoot').innerHTML = '<div class="small-muted">Failed to load results.</div>';
    return;
  }
  renderTickets(data);
}

/* initial load */
doSearch();
</script>
</body>
</html>
