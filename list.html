<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Open Requests</title>
  <style>
    body { font-family: Arial; margin: 40px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th { background: #f4f4f4; }
    button { padding: 6px 12px; cursor: pointer; }
  </style>
</head>
<body>

<h2>Open Requests</h2>

<button onclick="loadRequests()">Refresh</button>

<p>To close a request, the requester must use their request ID (shown on submission).</p>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th>From</th>
      <th>To</th>
      <th>Date</th>
      <th>Mobile</th>
      <th>Email</th>
      <th>Info</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="requestTable"></tbody>
</table>

<script>
const BASE_URL = "https://weightshare-backend.weightshare.workers.dev";

async function loadRequests() {
  const res = await fetch(`${BASE_URL}/list`);
  const json = await res.json();

  const tbody = document.getElementById("requestTable");
  tbody.innerHTML = "";

  json.forEach(r => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${r.id || ""}</td>
      <td>${r.name || ""}</td>
      <td>${r.from_loc || ""}</td>
      <td>${r.to_loc || ""}</td>
      <td>${r.datepickup || ""}</td>
      <td>${r.mobile || ""}</td>
      <td>${r.email || ""}</td>
      <td>${(r.additionalinfo || "").slice(0,80)}</td>
      <td><button onclick="closeRequest('${r.id}')">Close</button></td>
    `;
    tbody.appendChild(row);
  });
}

async function closeRequest(id) {
  const secret = prompt("Enter the request ID to confirm closing:");

  if (!secret || secret !== id) {
    alert("Incorrect ID â€” only the requester can close the request.");
    return;
  }

  const res = await fetch(`${BASE_URL}/close?id=${id}`, { method: "POST" });
  const json = await res.json();

  if (json.success) {
    alert("Request closed.");
    loadRequests();
  } else {
    alert("Error closing request.");
  }
}

loadRequests();
</script>

</body>
</html>
